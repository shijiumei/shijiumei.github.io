大部分通信的双方都在不同的网段，因此对于WebRTC来说，P2P和relay才是它的主要应用场景

NAT在真实的网络环境中随处可见，它的出现主要出于两个目的：
一是为了解决IPv4地址不够用的问题
二是为了解决安全问题。
  使用NAT后，主机隐藏在内网，这样黑客就很难访问到内网主机
  从而达到保护内网主机的目的
  
NAT就是一种地址映射技术，它在内网地址与外网地址之间建立了映射关系

RFC3489和RFC5389就是最重要的两份NAT穿越的协议文档
在RFC3489协议中，将NAT分成4种类型，
  完全锥形
  IP限制锥型
  端口限制锥型
  对称性
这4中类型中，越往后的NAT类型穿越难度越大

完全锥形NAT
  特点：一旦打洞成功，所有知道该动的主机都可以通过它与内网主机进行通信
  
  当host主机通过NAT访问外网主机B时，就会在NAT上打个洞。
  如果主机B将该洞的信息分享给主机A和C，
  那么知道这个洞的主机A和C都可以通过该洞给内网的host主机发送信息
  
  实际上，这里所谓的洞就是在NAT上建立了一个内外网的映射表
  将这个映射表简单的理解为一个4元组：
  ```js
  {
    内网IP，
    内网端口,
    映射的外网IP,
    映射的外网端口
  }
  ```
  在NAT上有了这张映射表，所有发向这个洞的数据都会被NAT中转到内网的host主机。
  而在host主机上，侦听其内网端口的应用程序可以收到所有发向它的数据
  
  需要注意的是，大多数情况下NAT穿越使用的是UDP，这是因为UDP是无连接协议的，打洞会更加方便
  当然，也可以使用TCP打洞

IP限制锥型NAT
  IP限制锥型NAT要比完全锥型NAT严格得多
  IP限制锥型NAT的主要特点：
    NAT打洞成功后，只有与之打洞成功的外网主机才能通过该洞与内网主机通信
    而其他外网主机即使知道洞口也不能与之通信
    
  host主机访问主机B时，在NAT上打了一个洞
  此时，只有主机B才能通过该洞向内网host主机发送信息，
  而其他外网主机（如A与C）不能再像完全锥型NAT一样通过该洞与内网host主机通信了
  
  但需要注意的是，主机B上不同的端口（如p1、p2等）是可以向host主机发送消息的
  
  之所以会如此，是因为NAT对穿越洞口的IP地址做了限制，只有登记过的外网IP地址才可以通过NAT
  换句话说，只有host主机访问过的外网主机才能穿越这个洞
  
  IP限制锥型NAT是如何检测数据包是否合法的呢？
  当外网主机通过IP限制锥型NAT向内网主机发送信息时，
  NAT会检测数据包头中的源IP地址是否在NAT映射表中有记录
  如果有记录，说明是合法数据，可以进行数据转发
  如果没有记录，说明是非法数据，NAT会将该数据包直接丢弃
  
  IP限制锥型NAT的打洞映射表示一个5元组
  ```
  {
    内网IP，
    内网端口，
    映射的外网IP，
    映射的外网端口
    [被访问主机的IP, ... ]
  }
  ```
  IP限制锥型NAT比完全锥型NAT对数据包的控制更严格，
  只有通过IP检测的数据包才能穿越IP限制锥型NAt
  
  此外，由于IP限制锥型NAT只对IP做检测，因此只要IP检测通过了，使用哪个端口就无所谓了
  
端口限制锥型NAT
  端口限制锥型NAT比IP限制锥型更加严格
  特点：
    除了像IP限制锥型NAT一样需要对IP地址进行检测外，还需要对端口进行检测
    
  host主机访问主机B时NAT上打了一个洞
  此时外网主机A和C是访问不了内网host主机的，
  这与IP限制锥型NAT是一样的
  此外，如果host主机访问的是主机B的p1端口，那么只有主机B的p1端口发送的消息才能穿越NAT，
  而主机B的p2端口已无法再通过NAT了
  
  所以，虽然端口限制型NAT的映射表也是5元组，但它与IP限制锥型NAT的映射表还是有重要区别的，
  ```
  {
    内网IP，
    内网端口，
    映射的外网IP，
    映射的外网端口，
    [
      { 被访问主机的IP，被访问主机的端口 }，
      ...
    ]
  }
  ```
  
对称型NAT
  特点：
    内网主机每次访问不同的外网主机时，都会生成一个新洞，而不像前面3种NAT类型使用的是同一个洞
    
  在对称型NAT中，host主机访问主机B时在NAT上打了一个洞，此时只有主机B上相应端口发送的数据才能穿越该洞
  这一点与端口限制型NAT是一致的
  它与端口限制型NAt最大的不同时当host主机访问外网主机A时，它与主机A之间会新建一个洞，而不是复用访问主机B时的洞
  
  也就是说，对于对称型NAT来说，访问不同的主机会产生不同的新洞，这给我们进行NAT穿越造成了极大的麻烦
  
  对称型NAT的映射表示一个6元组
  其映射的外网IP地址和外网端口会随着访问目的主机的不同而变化
  
  对称型NAT每次访问不同外网主机都生成新洞的这种特性，
  导致对称型NAT碰到对称型NAT或者对称型NAT遇到端口限制型NAT时，双方打洞的成功率非常低，即使可以互通，成本也非常高
  WebRTC遇到上面这两种情况时，直接放弃打洞的尝试
  
  ```
  {
    内网IP，
    内网端口，
    
    映射的外网IP， // 不仅访问地址变化了，映射IP也要发生变化
    映射的外网端口， // 不仅访问地址变化了，映射端口也要发生变化
    
    被访问主机的Ip，
    被访问主机的端口
  }
  ```
  
NAT类型检测
  对于内网主机来说，它是如何知道自己是哪种NAT类型的呢？
  实际上，RFC3489协议中已经给出标准的检测流程
  
  需要注意的是，内网主机进行NAT类型检测时，需要用到两台STUN服务器，每台STUN服务器又需要两块网卡，
  每块网卡都需要配置公网IP地址，只有这样，环境才能符合检测流程的需求
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
